{% extends 'base.html' %}
{% load static l10n %}

{% block title %}{{ property.name }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="mb-6 flex items-start justify-between">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">{{ property.name }}</h1>
        <div class="mt-2 text-gray-600">{{ property.city }} • {{ property.get_property_type_display }}</div>
        <div class="mt-1 flex items-center gap-2 text-sm">
          {% if property.is_verified_by_platform %}
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full bg-green-100 text-green-800">موثّق</span>
          {% endif %}
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full bg-gray-100 text-gray-700">خصوصية: {{ property.privacy_rating }}/5</span>
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full bg-gray-100 text-gray-700">السعة: {{ property.capacity }}</span>
        </div>
        <div class="mt-2 flex items-center gap-2 text-sm">
          {% with r=avg_rating %}
            {% if r %}
              {% for i in "12345" %}
                {% if forloop.counter <= r %}
                  <svg class="w-4 h-4 text-yellow-500" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.802 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118L10 13.347l-2.885 2.134c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L3.48 8.719c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                {% else %}
                  <svg class="w-4 h-4 text-gray-300" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.802 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118L10 13.347l-2.885 2.134c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L3.48 8.719c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                {% endif %}
              {% endfor %}
              <span class="ml-1 text-gray-800">{{ r|floatformat:1 }}</span>
              <span class="text-gray-500">({{ reviews_count|default:"0" }} تقييم)</span>
            {% else %}
              <span class="text-gray-500">لا تقييم</span>
            {% endif %}
          {% endwith %}
        </div>
      </div>
      <div class="text-right">
        <div class="grid grid-cols-3 gap-2 text-center text-sm">
          <div class="bg-white rounded p-2 shadow">
            <div class="text-gray-500">بالساعة</div>
            <div class="font-bold text-blue-600">{{ property.price_per_hour|default:"-" }}</div>
          </div>
          <div class="bg-white rounded p-2 shadow">
            <div class="text-gray-500">نصف يوم</div>
            <div class="font-bold text-blue-600">{{ property.price_half_day|default:"-" }}</div>
          </div>
          <div class="bg-white rounded p-2 shadow">
            <div class="text-gray-500">اليوم</div>
            <div class="font-bold text-blue-600">{{ property.price_per_day|default:"-" }}</div>
          </div>
        </div>
        <a href="{% url 'booking:create_property_booking' property_id=property.id %}" class="mt-3 inline-block px-5 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">احجز الآن</a>
        <p class="mt-2 text-xs text-gray-500 text-center">سيتم التحقق من التوفر عند اختيار الوقت</p>
      </div>
    </div>

    <!-- Gallery -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
      <div class="md:col-span-2">
        {% if property.main_image %}
          <img src="{{ property.main_image.url }}" alt="{{ property.name }}" class="w-full h-80 object-cover rounded-lg shadow">
        {% else %}
          <div class="w-full h-80 bg-gray-200 rounded-lg"></div>
        {% endif %}
      </div>
      <div class="space-y-4">
        {% for a in property.amenities.all|slice:':6' %}
          <div class="bg-white rounded-lg p-3 shadow flex items-center justify-between">
            <span class="text-gray-800">{{ a.name }}</span>
            {% if a.icon_class %}
              <i class="{{ a.icon_class }} text-gray-500"></i>
            {% endif %}
          </div>
        {% empty %}
          <div class="bg-white rounded-lg p-3 shadow text-gray-500">لا توجد مزايا مضافة</div>
        {% endfor %}
      </div>
    </div>

    <!-- Gallery Images -->
    {% if property.gallery_images.exists %}
    <div class="bg-white rounded-xl shadow p-6 mb-8">
      <h2 class="text-xl font-bold text-gray-900 mb-4">معرض الصور</h2>
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
        {% for img in property.gallery_images.all %}
          <div class="relative group">
            <img src="{{ img.image.url }}" alt="{{ img.caption|default:property.name }}" class="w-full h-48 object-cover rounded-lg shadow hover:shadow-lg transition-shadow">
            {% if img.caption %}
              <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-xs p-2 rounded-b-lg opacity-0 group-hover:opacity-100 transition-opacity">
                {{ img.caption }}
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Description -->
    <div class="bg-white rounded-xl shadow p-6 mb-8">
      <h2 class="text-xl font-bold text-gray-900 mb-3">الوصف</h2>
      <p class="text-gray-700 leading-relaxed">{{ property.description }}</p>
    </div>

    <!-- Reviews -->
    <div class="bg-white rounded-xl shadow p-6 mb-8">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold text-gray-900">التقييمات</h2>
        <div class="flex items-center gap-2 text-sm text-gray-600">
          <svg class="w-4 h-4 text-yellow-500" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.802 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118L10 13.347l-2.885 2.134c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L3.48 8.719c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
          <span>{{ avg_rating|default:"-"|floatformat:1 }}</span>
          <span>•</span>
          <span>{{ reviews_count|default:"0" }} تقييم</span>
        </div>
      </div>
      <div class="space-y-4">
        {% for r in reviews %}
          <div class="border border-gray-200 rounded-lg p-4">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-1 text-sm text-gray-700">
                {% for i in "12345" %}
                  {% if forloop.counter <= r.rating %}
                    <svg class="w-4 h-4 text-yellow-500" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.802 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118L10 13.347l-2.885 2.134c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L3.48 8.719c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                  {% else %}
                    <svg class="w-4 h-4 text-gray-300" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.802 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118L10 13.347l-2.885 2.134c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L3.48 8.719c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                  {% endif %}
                {% endfor %}
                <span class="ml-1 font-semibold">{{ r.rating }}/5</span>
              </div>
              <div class="text-xs text-gray-500">{{ r.created_at|date:"Y-m-d H:i" }}</div>
            </div>
            {% if r.comment %}
            <p class="mt-2 text-gray-800 leading-relaxed">{{ r.comment }}</p>
            {% endif %}
          </div>
        {% empty %}
          <div class="text-gray-500">لا توجد تقييمات بعد</div>
        {% endfor %}
      </div>
    </div>

    <!-- Add Review -->
    <div class="bg-white rounded-xl shadow p-6 mb-8">
      <h2 class="text-xl font-bold text-gray-900 mb-4">أضف تقييمك</h2>
      {% if user.is_authenticated %}
      <form method="post">
        {% csrf_token %}
        <div class="grid grid-cols-1 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">التقييم</label>
            {{ review_form.rating }}
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">تعليق</label>
            {{ review_form.comment }}
          </div>
          <div class="flex justify-end">
            <button type="submit" class="px-5 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">إرسال</button>
          </div>
        </div>
      </form>
      {% else %}
        <p class="text-gray-600">الرجاء <a href="{% url 'accounts:login' %}?next={{ request.path }}" class="text-blue-600 hover:underline">تسجيل الدخول</a> لإضافة تقييم.</p>
      {% endif %}
    </div>
    <!-- Map/address -->
    <div class="bg-white rounded-xl shadow p-6 mb-8">
      <h2 class="text-xl font-bold text-gray-900 mb-3">الموقع</h2>
      <div class="text-gray-700 mb-3">{{ property.address|default:"العنوان غير متوفر" }}</div>
      {% if property.latitude and property.longitude %}
        <div id="property-map" class="w-full h-64 rounded-lg"></div>
      {% else %}
        <div class="w-full h-64 bg-gray-200 rounded-lg flex items-center justify-center">
          <div class="text-center">
            <svg class="w-12 h-12 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            <p class="text-gray-500">الموقع غير محدد على الخريطة</p>
          </div>
        </div>
      {% endif %}
    </div>

  </div>
</div>
{% endblock %}

{% block extra_js %}
{% if property.latitude and property.longitude %}
<script>
(function() {
  function initMap() {
    var lat, lng;
    // Ensure numbers are unlocalized for JS parsing
    {% localize off %}
    lat = {{ property.latitude|default:'null' }};
    lng = {{ property.longitude|default:'null' }};
    {% endlocalize %}
    if (lat === null || lng === null) { return; }

    var map = L.map('property-map').setView([lat, lng], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      maxZoom: 19
    }).addTo(map);

    var marker = L.marker([lat, lng]).addTo(map);
    marker.bindPopup('<b>{{ property.name|escapejs }}</b><br>{{ property.city|escapejs }}').openPopup();

    setTimeout(function(){ map.invalidateSize(); }, 0);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMap);
  } else {
    initMap();
  }
})();
</script>
{% endif %}
{% endblock %}
